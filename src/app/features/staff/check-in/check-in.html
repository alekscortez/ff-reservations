<section class="mx-auto grid w-full max-w-4xl gap-4 px-3 pb-20 pt-3 md:px-5">
  <header class="rounded-2xl border border-brand-100 bg-white p-4 md:p-5">
    <h1 class="text-2xl font-semibold text-brand-900 md:text-3xl">Check-In</h1>
    <p class="mt-1 text-sm text-brand-600">Issue one-time passes and validate entry at the door.</p>
  </header>

  <article class="rounded-2xl border border-brand-100 bg-white p-4 md:p-5">
    <h2 class="text-sm font-semibold uppercase tracking-[0.12em] text-brand-500">Pass Issuance</h2>
    <div class="mt-3 grid gap-3 md:grid-cols-[1fr_2fr_auto_auto]">
      <label class="grid gap-1 text-xs text-brand-600">
        Event Date
        <input
          type="date"
          [(ngModel)]="eventDate"
          class="h-11 rounded-lg border border-brand-200 px-3 text-base md:text-sm"
        />
      </label>

      <label class="grid gap-1 text-xs text-brand-600">
        Reservation ID
        <input
          type="text"
          [(ngModel)]="reservationId"
          placeholder="Reservation UUID"
          class="h-11 rounded-lg border border-brand-200 px-3 text-base md:text-sm"
        />
      </label>

      <button
        type="button"
        class="h-11 rounded-lg border border-brand-200 px-4 text-sm font-semibold text-brand-900 disabled:opacity-60"
        (click)="fetchOrCreatePass()"
        [disabled]="loadingPass"
      >
        {{ loadingPass ? 'Loading…' : 'Get Pass' }}
      </button>

      <button
        type="button"
        class="h-11 rounded-lg bg-brand-900 px-4 text-sm font-semibold text-white disabled:opacity-60"
        (click)="reissuePass()"
        [disabled]="loadingPass"
      >
        Reissue
      </button>
    </div>

    <div class="mt-3 rounded-xl border border-brand-100 bg-brand-50 p-3 text-sm" *ngIf="currentPass">
      <p class="font-semibold text-brand-900">
        Pass {{ currentPass.passId }} · Table {{ currentPass.tableId }} · {{ currentPass.status }}
      </p>
      <p class="mt-1 text-xs text-brand-600">
        Expires at epoch {{ currentPass.expiresAt }}. One successful scan will consume this pass.
      </p>

      <div class="mt-3 grid gap-2">
        <label class="grid gap-1 text-xs text-brand-600">
          Pass Link
          <input
            type="text"
            readonly
            [value]="currentPass.url || ''"
            class="h-11 rounded-lg border border-brand-200 bg-white px-3 text-xs text-brand-900"
          />
        </label>

        <label class="grid gap-1 text-xs text-brand-600">
          Token (for scanner fallback)
          <input
            type="text"
            readonly
            [value]="currentPass.token || ''"
            class="h-11 rounded-lg border border-brand-200 bg-white px-3 text-xs text-brand-900"
          />
        </label>

        <label class="grid gap-1 text-xs text-brand-600">
          QR Payload
          <input
            type="text"
            readonly
            [value]="currentPass.qrPayload || ''"
            class="h-11 rounded-lg border border-brand-200 bg-white px-3 text-xs text-brand-900"
          />
        </label>
      </div>

      <div class="mt-3 flex flex-wrap gap-2">
        <button
          type="button"
          class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-900"
          (click)="copyPassLink()"
        >
          Copy Link
        </button>
        <button
          type="button"
          class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-900"
          (click)="openSms()"
        >
          SMS
        </button>
        <button
          type="button"
          class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-900"
          (click)="openWhatsApp()"
        >
          WhatsApp
        </button>
      </div>
    </div>
  </article>

  <article class="rounded-2xl border border-brand-100 bg-white p-4 md:p-5">
    <h2 class="text-sm font-semibold uppercase tracking-[0.12em] text-brand-500">Scanner</h2>
    <p class="mt-1 text-sm text-brand-600">
      Use camera scan for fastest check-in. Manual paste is available as fallback.
    </p>

    <div class="mt-3 grid gap-3 rounded-xl border border-brand-100 bg-brand-50 p-3">
      <div class="flex flex-wrap items-center gap-2">
        <button
          type="button"
          class="h-10 rounded-lg bg-brand-900 px-3 text-sm font-semibold text-white disabled:opacity-60"
          (click)="startScanner()"
          [disabled]="!scannerSupported || scannerActive"
        >
          Start Camera
        </button>
        <button
          type="button"
          class="h-10 rounded-lg border border-brand-200 px-3 text-sm font-semibold text-brand-900 disabled:opacity-60"
          (click)="stopScanner()"
          [disabled]="!scannerActive"
        >
          Stop
        </button>
        <button
          type="button"
          class="h-10 rounded-lg border border-brand-200 px-3 text-sm font-semibold text-brand-900 disabled:opacity-60"
          (click)="toggleCameraFacing()"
          [disabled]="!scannerSupported"
        >
          Flip Camera
        </button>
        <span
          class="rounded-full border px-2 py-1 text-[11px] font-semibold"
          [ngClass]="scannerActive ? 'border-success-300 bg-success-100 text-success-800' : 'border-brand-200 bg-white text-brand-600'"
        >
          {{ scannerActive ? 'Camera Active' : 'Camera Off' }}
        </span>
      </div>

      <p class="text-xs text-brand-600" *ngIf="!scannerSupported">
        Camera scanning is not supported on this browser. Use manual input below.
      </p>
      <p class="text-xs text-danger-700" *ngIf="scannerError">{{ scannerError }}</p>

      <div class="overflow-hidden rounded-lg border border-brand-200 bg-black" *ngIf="scannerSupported">
        <video
          #scannerVideo
          class="h-56 w-full object-cover md:h-72"
          playsinline
          muted
        ></video>
      </div>
    </div>

    <div class="mt-3 grid gap-3 md:grid-cols-[1fr_180px_auto]">
      <label class="grid gap-1 text-xs text-brand-600">
        QR / Token / URL
        <input
          type="text"
          [(ngModel)]="scannerInput"
          placeholder="Scan or paste pass payload"
          class="h-11 rounded-lg border border-brand-200 px-3 text-base md:text-sm"
        />
      </label>

      <label class="grid gap-1 text-xs text-brand-600">
        Scanner Device
        <input
          type="text"
          [(ngModel)]="scannerDevice"
          class="h-11 rounded-lg border border-brand-200 px-3 text-base md:text-sm"
        />
      </label>

      <button
        type="button"
        class="h-11 rounded-lg bg-brand-900 px-4 text-sm font-semibold text-white disabled:opacity-60"
        (click)="verify()"
        [disabled]="loadingVerify"
      >
        {{ loadingVerify ? 'Verifying…' : 'Verify Check-In' }}
      </button>
    </div>

    <div class="mt-3 rounded-xl border p-3 text-sm" *ngIf="verifyResult" [ngClass]="resultBadgeClass()">
      <div class="flex flex-wrap items-center gap-2">
        <span class="rounded-full border px-2 py-0.5 text-xs font-semibold">{{ verifyResult.code }}</span>
        <span class="font-semibold">{{ verifyResult.message }}</span>
      </div>
      <p class="mt-2 text-xs">
        Reservation {{ verifyResult.reservation?.reservationId }} ·
        Table {{ verifyResult.reservation?.tableId }} ·
        {{ verifyResult.reservation?.customerName }}
      </p>
      <p class="mt-1 text-xs" *ngIf="verifyResult.pass?.usedAt">
        Used at epoch {{ verifyResult.pass?.usedAt }} by {{ verifyResult.pass?.usedBy }}
      </p>
    </div>
  </article>

  <p class="rounded-lg border border-danger-200 bg-danger-50 px-3 py-2 text-sm text-danger-700" *ngIf="error">
    {{ error }}
  </p>
  <p class="rounded-lg border border-success-200 bg-success-50 px-3 py-2 text-sm text-success-700" *ngIf="notice">
    {{ notice }}
  </p>
</section>
