<section class="flex w-full flex-col gap-4">
  <header class="rounded-2xl border border-brand-100 bg-white p-4 md:p-6">
    <div class="flex items-start justify-between gap-3">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.18em] text-brand-500">Staff Dashboard</p>
        <h1 class="text-2xl font-semibold text-brand-900">Live Table Overview</h1>
      </div>
      <button
        type="button"
        class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-brand-200 text-brand-700"
        (click)="refreshDashboard()"
        [disabled]="loadingContext || loadingSnapshot"
        title="Refresh dashboard"
        aria-label="Refresh dashboard"
      >
        ↻
      </button>
    </div>

    <div *ngIf="loadingContext" class="mt-3 text-sm text-brand-500">Loading event context…</div>

    <div *ngIf="!loadingContext && contextEvent" class="mt-4 grid gap-3 md:grid-cols-[1fr_auto] md:items-center">
      <div>
        <p class="text-[11px] uppercase tracking-[0.15em] text-brand-500">{{ contextLabel }}</p>
        <h2 class="text-xl font-semibold text-brand-900">{{ contextEvent.eventName }}</h2>
        <p class="text-sm text-brand-600">{{ formatEventDate(contextEvent.eventDate) }} · {{ contextEvent.status }}</p>
      </div>
      <a
        [routerLink]="['/staff/reservations/new']"
        [queryParams]="{ date: contextEvent.eventDate }"
        class="inline-flex h-11 items-center justify-center rounded-lg bg-brand-900 px-4 text-sm font-semibold text-white"
      >
        New Reservation
      </a>
    </div>

    <div *ngIf="!loadingContext && !contextEvent" class="mt-4 rounded-xl border border-brand-100 bg-brand-50 px-4 py-3 text-sm text-brand-700">
      No active event found for today. Create/activate an event to see live floor metrics.
    </div>

    <p class="mt-3 text-sm text-danger-700" *ngIf="error">{{ error }}</p>
  </header>

  <section class="grid gap-3 sm:grid-cols-2 lg:grid-cols-5">
    <article class="rounded-xl border border-brand-100 bg-white p-4">
      <p class="text-xs uppercase tracking-[0.14em] text-brand-500">Total</p>
      <p class="mt-2 text-2xl font-semibold text-brand-900">{{ kpis.total }}</p>
    </article>
    <article class="rounded-xl border border-success-200 bg-success-50 p-4">
      <p class="text-xs uppercase tracking-[0.14em] text-success-700">Available</p>
      <p class="mt-2 text-2xl font-semibold text-success-700">{{ kpis.available }}</p>
    </article>
    <article class="rounded-xl border border-accent-200 bg-accent-50 p-4">
      <p class="text-xs uppercase tracking-[0.14em] text-accent-700">On Hold</p>
      <p class="mt-2 text-2xl font-semibold text-accent-800">{{ kpis.hold }}</p>
    </article>
    <article class="rounded-xl border border-brand-200 bg-brand-50 p-4">
      <p class="text-xs uppercase tracking-[0.14em] text-brand-700">Reserved</p>
      <p class="mt-2 text-2xl font-semibold text-brand-900">{{ kpis.reserved }}</p>
    </article>
    <article class="rounded-xl border border-brand-200 bg-white p-4">
      <p class="text-xs uppercase tracking-[0.14em] text-brand-500">Disabled</p>
      <p class="mt-2 text-2xl font-semibold text-brand-700">{{ kpis.disabled }}</p>
    </article>
  </section>

  <section class="grid gap-4 lg:grid-cols-[1.15fr_1fr]">
    <article class="rounded-2xl border border-brand-100 bg-white p-4 md:p-5">
      <div class="flex items-center justify-between gap-2">
        <h3 class="text-lg font-semibold text-brand-900">Urgent Payments</h3>
        <a [routerLink]="['/staff/reservations']" class="text-xs font-semibold uppercase tracking-[0.12em] text-brand-600">Open List</a>
      </div>

      <div *ngIf="loadingSnapshot" class="mt-3 text-sm text-brand-500">Updating…</div>
      <div *ngIf="!loadingSnapshot && urgentPayments.length === 0" class="mt-3 rounded-lg border border-brand-100 bg-brand-50 px-3 py-2 text-sm text-brand-600">
        No pending or partial reservations due soon.
      </div>

      <div class="mt-3 grid gap-2" *ngIf="urgentPayments.length > 0">
        <article
          *ngFor="let item of urgentPayments"
          class="rounded-xl border px-3 py-2"
          [ngClass]="urgencyClass(item)"
        >
          <div class="flex items-start justify-between gap-2">
            <div>
              <p class="text-sm font-semibold">Table {{ item.reservation.tableId }} · {{ item.reservation.customerName }}</p>
              <p class="text-xs opacity-80">{{ item.reservation.paymentStatus }} · Due {{ formatDeadlineShort(item.reservation.paymentDeadlineAt, item.reservation.eventDate) }}</p>
            </div>
            <div class="flex flex-col items-end gap-1">
              <span class="rounded-full border px-2 py-0.5 text-[11px] font-semibold uppercase tracking-[0.12em]">
                {{ item.urgency === 'OVERDUE' ? 'Overdue' : 'Due Soon' }}
              </span>
              <button
                type="button"
                class="rounded-full border border-current bg-white/70 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-[0.1em] transition hover:bg-white disabled:cursor-not-allowed disabled:opacity-50"
                (click)="sendPaymentLinkSms(item.reservation)"
                [disabled]="paymentLinkLoadingId === item.reservation.reservationId || !canGeneratePaymentLink(item.reservation)"
              >
                {{ paymentLinkLoadingId === item.reservation.reservationId ? 'Sending…' : 'Send SMS' }}
              </button>
              <button
                type="button"
                class="rounded-full border border-current bg-white/70 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-[0.1em] transition hover:bg-white disabled:cursor-not-allowed disabled:opacity-50"
                (click)="openUrgentPayment(item)"
                [disabled]="paymentLoading || !canTakePayment(item.reservation)"
              >
                Take Payment
              </button>
            </div>
          </div>

          <div class="mt-2 grid gap-2 rounded-lg border border-current/20 bg-white/70 p-2" *ngIf="getPaymentLink(item.reservation) as paymentLink">
            <p class="text-[11px] opacity-80">
              Link ready · {{ paymentLink.createdAtMs | date:'shortTime' }} · ${{ paymentLink.amount | number:'1.2-2' }}
            </p>
            <input
              type="text"
              class="h-9 rounded-lg border border-current/25 bg-white px-2 text-xs"
              [value]="paymentLink.url"
              readonly
            />
            <div class="flex flex-wrap gap-2">
              <button
                type="button"
                class="h-8 rounded-lg border border-current/30 bg-white px-2 text-[11px] font-semibold uppercase tracking-[0.1em]"
                (click)="copyPaymentLink(item.reservation)"
              >
                Copy
              </button>
              <button
                type="button"
                class="h-8 rounded-lg border border-current/30 bg-white px-2 text-[11px] font-semibold uppercase tracking-[0.1em]"
                (click)="openSmsShare(item.reservation)"
              >
                SMS
              </button>
              <button
                type="button"
                class="h-8 rounded-lg border border-current/30 bg-white px-2 text-[11px] font-semibold uppercase tracking-[0.1em]"
                (click)="openWhatsAppShare(item.reservation)"
              >
                WhatsApp
              </button>
              <button
                type="button"
                class="h-8 rounded-lg border border-current/30 bg-white px-2 text-[11px] font-semibold uppercase tracking-[0.1em]"
                (click)="sharePaymentLink(item.reservation)"
              >
                Share
              </button>
            </div>
          </div>
        </article>
      </div>

      <p class="mt-3 text-sm text-danger-700" *ngIf="paymentLinkError">{{ paymentLinkError }}</p>
      <p class="mt-3 text-sm text-success-700" *ngIf="paymentLinkNotice">{{ paymentLinkNotice }}</p>
    </article>

    <article class="rounded-2xl border border-brand-100 bg-white p-4 md:p-5">
      <h3 class="text-lg font-semibold text-brand-900">Quick Actions</h3>
      <div class="mt-3 grid gap-2">
        <a
          [routerLink]="['/staff/reservations/new']"
          [queryParams]="contextEvent ? { date: contextEvent.eventDate } : null"
          class="inline-flex h-11 items-center justify-between rounded-lg border border-brand-200 px-3 text-sm font-semibold text-brand-900"
        >
          <span>New Reservation</span>
          <span aria-hidden="true">→</span>
        </a>
        <a
          [routerLink]="['/staff/reservations']"
          class="inline-flex h-11 items-center justify-between rounded-lg border border-brand-200 px-3 text-sm font-semibold text-brand-900"
        >
          <span>Reservations</span>
          <span aria-hidden="true">→</span>
        </a>
        <a
          [routerLink]="['/staff/check-in']"
          class="inline-flex h-11 items-center justify-between rounded-lg border border-brand-200 px-3 text-sm font-semibold text-brand-900"
        >
          <span>Check-In</span>
          <span aria-hidden="true">→</span>
        </a>
      </div>

      <div class="mt-4 rounded-lg border border-brand-100 bg-brand-50 p-3 text-xs text-brand-600" *ngIf="nextUpcomingEvent && contextLabel === 'NEXT EVENT'">
        Today has no active event. Showing next event context: <span class="font-semibold text-brand-800">{{ nextUpcomingEvent.eventName }}</span>
      </div>
    </article>
  </section>

  <section class="rounded-2xl border border-brand-100 bg-white p-4 md:p-5">
    <div class="flex items-center justify-between gap-2">
      <h3 class="text-lg font-semibold text-brand-900">Recent Activity</h3>
      <span class="text-xs uppercase tracking-[0.14em] text-brand-500">Latest {{ recentActivity.length }}</span>
    </div>

    <div *ngIf="loadingSnapshot" class="mt-3 text-sm text-brand-500">Updating…</div>
    <div *ngIf="!loadingSnapshot && recentActivity.length === 0" class="mt-3 rounded-lg border border-brand-100 bg-brand-50 px-3 py-2 text-sm text-brand-600">
      No recent reservation activity for this event.
    </div>

    <div class="mt-3 grid gap-2" *ngIf="recentActivity.length > 0">
      <button
        type="button"
        class="cursor-pointer rounded-xl border px-3 py-2 text-left transition-colors"
        [ngClass]="activityCardClass(activity)"
        *ngFor="let activity of recentActivity"
        (click)="openActivityDetails(activity)"
      >
        <div class="flex items-start justify-between gap-2">
          <div>
            <p class="text-sm font-semibold text-brand-900">Table {{ activity.tableId }} · {{ activity.customerName }}</p>
            <p class="text-xs text-brand-600">{{ activity.label }}</p>
          </div>
          <div class="text-right">
            <span class="inline-flex rounded-full px-2 py-0.5 text-[11px] font-semibold" [ngClass]="activityBadgeClass(activity)">
              {{ activityTypeLabel(activity) }}
            </span>
            <p class="mt-1 text-[11px] text-brand-500">{{ formatEpoch(activity.atEpoch) }}</p>
          </div>
        </div>
      </button>
    </div>
  </section>
</section>

<div class="fixed inset-0 z-[120] flex items-center justify-center" *ngIf="showDetailsModal && detailItem">
  <div class="absolute inset-0 bg-black/40" (click)="closeDetails()"></div>
  <section class="relative h-[92dvh] w-[94vw] max-w-2xl overflow-auto overflow-x-hidden rounded-2xl bg-white p-4 md:h-auto md:p-6">
    <div class="flex items-start justify-between gap-3">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.16em] text-brand-500">Reservation</p>
        <h3 class="text-xl font-semibold text-brand-900">Table {{ detailItem.tableId }}</h3>
        <p class="break-words text-sm text-brand-600">{{ detailItem.customerName }} · {{ detailItem.phone | phoneDisplay }}</p>
      </div>
      <button
        type="button"
        class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-brand-200 text-xs text-brand-700"
        (click)="closeDetails()"
        aria-label="Close details"
      >
        ✕
      </button>
    </div>

    <div class="mt-4 grid grid-cols-2 gap-2">
      <article class="rounded-xl border border-brand-100 bg-brand-50 px-3 py-2">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Status</p>
        <p class="text-sm font-semibold text-brand-900">{{ detailItem.status }}</p>
      </article>
      <article class="rounded-xl border border-brand-100 bg-brand-50 px-3 py-2">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Payment</p>
        <p class="text-sm font-semibold text-brand-900">{{ detailItem.paymentStatus || '—' }}</p>
      </article>
      <article class="rounded-xl border border-brand-100 bg-brand-50 px-3 py-2">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Deposit</p>
        <p class="text-sm font-semibold text-brand-900">${{ detailItem.depositAmount }}</p>
      </article>
      <article class="rounded-xl border border-brand-100 bg-brand-50 px-3 py-2">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Amount Due</p>
        <p class="text-sm font-semibold text-brand-900">${{ detailItem.amountDue ?? 0 }}</p>
      </article>
    </div>

    <div class="mt-4 grid gap-3">
      <article class="rounded-xl border border-brand-100 p-3">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Payment Info</p>
        <dl class="mt-2 grid gap-2 text-sm text-brand-800">
          <div class="flex items-center justify-between gap-3">
            <dt class="text-brand-500">Method</dt>
            <dd class="font-medium text-brand-900">{{ detailItem.paymentMethod | paymentMethodLabel }}</dd>
          </div>
          <div class="flex items-center justify-between gap-3">
            <dt class="text-brand-500">Deadline</dt>
            <dd class="font-medium text-brand-900">{{ formatDeadlineShort(detailItem.paymentDeadlineAt, detailItem.eventDate) }}</dd>
          </div>
        </dl>
      </article>

      <article class="rounded-xl border border-brand-100 p-3" *ngIf="canGeneratePaymentLink(detailItem)">
        <div class="flex items-center justify-between gap-3">
          <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Payment Link</p>
          <div class="flex items-center gap-2">
            <button
              type="button"
              class="h-8 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800 disabled:cursor-not-allowed disabled:opacity-50"
              [disabled]="paymentLinkLoadingId === detailItem.reservationId || !canGeneratePaymentLink(detailItem)"
              (click)="sendPaymentLinkSms(detailItem)"
            >
              {{ paymentLinkLoadingId === detailItem.reservationId ? 'Sending…' : 'Send SMS' }}
            </button>
            <button
              type="button"
              class="h-8 rounded-lg bg-brand-900 px-3 text-xs font-semibold text-white disabled:cursor-not-allowed disabled:opacity-50"
              [disabled]="paymentLinkLoadingId === detailItem.reservationId || !canGeneratePaymentLink(detailItem)"
              (click)="generatePaymentLink(detailItem)"
            >
              {{ paymentLinkLoadingId === detailItem.reservationId ? 'Generating…' : 'Generate Link' }}
            </button>
          </div>
        </div>

        <p class="mt-2 text-xs text-danger-700" *ngIf="paymentLinkError">{{ paymentLinkError }}</p>
        <p class="mt-2 text-xs text-success-700" *ngIf="paymentLinkNotice">{{ paymentLinkNotice }}</p>

        <div class="mt-2 rounded-lg border border-brand-100 bg-brand-50 p-2" *ngIf="getPaymentLinkSmsState(detailItem) as smsState">
          <div class="flex flex-wrap items-center gap-2">
            <span class="inline-flex rounded-full border px-2 py-0.5 text-[11px] font-semibold" [ngClass]="paymentLinkSmsBadgeClass(smsState.status)">
              {{ smsState.status === 'SENT' ? 'SMS SENT' : 'SMS FAILED' }}
            </span>
            <span class="text-xs text-brand-600">{{ smsState.atMs | date:'short' }}</span>
          </div>
          <p class="mt-1 text-xs text-brand-700" *ngIf="smsState.to">To {{ smsState.to }}</p>
          <p class="mt-1 break-all text-xs text-danger-700" *ngIf="smsState.errorMessage">{{ smsState.errorMessage }}</p>
        </div>

        <div class="mt-2 grid min-w-0 gap-2" *ngIf="getPaymentLink(detailItem) as paymentLink">
          <p class="text-xs text-brand-600">
            Generated {{ paymentLink.createdAtMs | date:'shortTime' }} · ${{ paymentLink.amount | number:'1.2-2' }}
          </p>
          <input
            type="text"
            class="h-10 w-full min-w-0 rounded-lg border border-brand-200 px-3 text-xs text-brand-900"
            [value]="paymentLink.url"
            readonly
          />
          <div class="flex flex-wrap gap-2">
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="copyPaymentLink(detailItem)"
            >
              Copy
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="openSmsShare(detailItem)"
            >
              SMS App
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="openWhatsAppShare(detailItem)"
            >
              WhatsApp
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="sharePaymentLink(detailItem)"
            >
              Share
            </button>
          </div>
          <p class="break-all text-xs text-brand-500">{{ paymentLinkShareMessage(detailItem) }}</p>
        </div>
      </article>

      <article class="rounded-xl border border-brand-100 p-3">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Check-In Pass</p>
          <button
            type="button"
            class="h-8 shrink-0 rounded-lg bg-brand-900 px-3 text-xs font-semibold text-white disabled:cursor-not-allowed disabled:opacity-50"
            [disabled]="checkInPassLoadingId === detailItem.reservationId || !canReissueCheckInPass(detailItem)"
            (click)="reissueCheckInPass(detailItem)"
          >
            {{ checkInPassLoadingId === detailItem.reservationId ? 'Reissuing…' : 'Reissue Pass' }}
          </button>
        </div>

        <p class="mt-2 text-xs text-brand-500" *ngIf="!canManageCheckInPass(detailItem)">
          Pass is available only for confirmed and fully paid reservations.
        </p>
        <p class="mt-2 text-xs text-brand-500" *ngIf="canManageCheckInPass(detailItem) && !canReissueCheckInPass(detailItem)">
          Reservation is already checked in. Reissue is disabled.
        </p>

        <div class="mt-2 rounded-lg border border-brand-100 bg-brand-50 p-2" *ngIf="getCheckInPassState(detailItem) as state">
          <div class="flex flex-wrap items-center gap-2">
            <span class="inline-flex rounded-full border px-2 py-0.5 text-[11px] font-semibold" [ngClass]="checkInStateBadgeClass(state.status)">
              {{ checkInStateLabel(state.status) }}
            </span>
            <span class="text-xs text-brand-600" *ngIf="epochSecondsToMs(state.usedAt) as usedAtMs">
              {{ usedAtMs | date:'short' }}
            </span>
          </div>
          <p class="mt-1 text-xs text-brand-700" *ngIf="state.usedBy">By {{ state.usedBy | systemActorLabel }}</p>
          <p class="mt-1 text-xs text-brand-700" *ngIf="state.revokedBy">Revoked by {{ state.revokedBy | systemActorLabel }}</p>
        </div>

        <p class="mt-2 text-xs text-danger-700" *ngIf="checkInPassError">{{ checkInPassError }}</p>
        <p class="mt-2 text-xs text-success-700" *ngIf="checkInPassNotice">{{ checkInPassNotice }}</p>

        <div class="mt-2 grid min-w-0 gap-2" *ngIf="getCheckInPass(detailItem) as pass">
          <p class="break-all text-xs text-brand-600">Pass {{ pass.passId }} · Updated {{ pass.createdAtMs | date:'shortTime' }}</p>
          <input
            type="text"
            class="h-10 w-full min-w-0 rounded-lg border border-brand-200 px-3 text-xs text-brand-900"
            [value]="pass.url"
            readonly
          />
          <div class="flex flex-wrap gap-2">
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="copyCheckInPassLink(detailItem)"
            >
              Copy
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="openSmsShareCheckInPass(detailItem)"
            >
              SMS
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="openWhatsAppShareCheckInPass(detailItem)"
            >
              WhatsApp
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="shareCheckInPassLink(detailItem)"
            >
              Share
            </button>
          </div>
          <p class="break-all text-xs text-brand-500">{{ checkInPassShareMessage(detailItem) }}</p>
        </div>
      </article>

      <details class="rounded-xl border border-brand-100 bg-white p-3">
        <summary class="cursor-pointer text-sm font-semibold text-brand-900">Activity Log</summary>

        <p class="mt-2 text-xs text-brand-500" *ngIf="historyLoadingId === detailItem.reservationId">Loading history…</p>
        <p class="mt-2 text-xs text-danger-700" *ngIf="historyError">{{ historyError }}</p>

        <div class="mt-3 grid gap-2" *ngIf="getHistory(detailItem) as historyItems">
          <p class="text-xs text-brand-500" *ngIf="historyItems.length === 0 && historyLoadingId !== detailItem.reservationId">
            No history yet for this reservation.
          </p>

          <article class="rounded-lg border border-brand-100 bg-brand-50 p-2" *ngFor="let h of historyItems">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <p class="text-xs font-semibold text-brand-900">{{ historyEventLabel(h.eventType) }}</p>
                <p class="mt-0.5 text-[11px] text-brand-600" *ngIf="historySummary(h) as summary">{{ summary }}</p>
                <p class="mt-0.5 text-[11px] text-brand-500">By {{ h.actor | systemActorLabel }}</p>
              </div>
              <div class="text-right">
                <span class="inline-flex rounded-full border px-2 py-0.5 text-[10px] font-semibold" [ngClass]="historyEventBadgeClass(h.eventType)">
                  {{ historyEventLabel(h.eventType) }}
                </span>
                <p class="mt-1 text-[11px] text-brand-500">{{ h.atMs | date:'short' }}</p>
              </div>
            </div>
          </article>
        </div>
      </details>

      <article class="rounded-xl border border-brand-100 p-3">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Audit</p>
        <dl class="mt-2 grid gap-2 text-sm text-brand-800">
          <div class="flex items-center justify-between gap-3">
            <dt class="text-brand-500">Created By</dt>
            <dd class="font-medium text-brand-900">{{ detailItem.createdBy || '—' }}</dd>
          </div>
          <div class="flex items-start justify-between gap-3">
            <dt class="text-brand-500">Cancel Reason</dt>
            <dd class="max-w-[70%] text-right font-medium text-brand-900">{{ detailItem.cancelReason || '—' }}</dd>
          </div>
        </dl>
      </article>
    </div>
  </section>
</div>

<div class="fixed inset-0 z-[120] flex items-center justify-center" *ngIf="showPaymentModal && paymentItem">
  <div class="absolute inset-0 bg-black/40" (click)="closeUrgentPayment()"></div>
  <section class="relative w-[92vw] max-w-md rounded-2xl bg-white p-4 md:p-6">
    <div class="flex items-center justify-between gap-3">
      <h3 class="text-lg font-semibold text-brand-900">Take Payment</h3>
      <button
        type="button"
        class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-brand-200 text-xs text-brand-700"
        (click)="closeUrgentPayment()"
        aria-label="Close payment modal"
      >
        ✕
      </button>
    </div>

    <p class="mt-2 text-sm text-brand-600">Table {{ paymentItem.tableId }} · {{ paymentItem.customerName }}</p>

    <form class="mt-4 grid gap-3" [formGroup]="paymentForm" (ngSubmit)="submitUrgentPayment()">
      <label class="grid gap-1 text-xs uppercase tracking-[0.12em] text-brand-500">
        Amount
        <input
          type="number"
          min="0.01"
          step="0.01"
          formControlName="amount"
          class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900"
        />
      </label>

      <label class="grid gap-1 text-xs uppercase tracking-[0.12em] text-brand-500">
        Method
        <select
          formControlName="method"
          class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900"
        >
          <option value="cash">Cash</option>
          <option value="cashapp">Cash App</option>
          <option value="square">Square</option>
        </select>
      </label>

      <label class="grid gap-1 text-xs uppercase tracking-[0.12em] text-brand-500">
        Note
        <input
          type="text"
          formControlName="note"
          class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900"
        />
      </label>

      <p class="text-sm text-danger-700" *ngIf="paymentError">{{ paymentError }}</p>
      <p class="text-xs text-brand-600" *ngIf="isSquarePaymentMethodSelected()">
        Square in this modal generates a payment link. Reader charge can be added later.
      </p>
      <p class="text-sm text-danger-700" *ngIf="paymentLinkError && isSquarePaymentMethodSelected()">{{ paymentLinkError }}</p>

      <button
        type="submit"
        class="h-11 rounded-lg bg-brand-900 text-sm font-semibold text-white disabled:opacity-50"
        [disabled]="
          isSquarePaymentMethodSelected()
            ? paymentLinkLoadingId === paymentItem?.reservationId || !paymentItem || !canGeneratePaymentLink(paymentItem)
            : paymentLoading || paymentForm.invalid
        "
      >
        {{
          isSquarePaymentMethodSelected()
            ? (paymentLinkLoadingId === paymentItem?.reservationId ? 'Generating…' : 'Generate Link')
            : (paymentLoading ? 'Saving…' : 'Submit Payment')
        }}
      </button>
    </form>
  </section>
</div>
