<section class="flex w-full flex-col gap-4">
  <header>
    <h1 class="text-2xl font-semibold text-brand-900">Reservations</h1>
    <p class="text-sm text-brand-600">View and manage reservations by date.</p>
  </header>

  <section class="w-full rounded-2xl border border-brand-100 bg-white p-4 md:p-6">
    <div class="flex items-center justify-between gap-3">
      <h2 class="text-lg font-semibold text-brand-900">Select Event</h2>
      <button
        type="button"
        class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-brand-200 text-brand-700"
        (click)="loadEvents()"
        [disabled]="eventsLoading"
        aria-label="Refresh events"
        title="Refresh events"
      >
        ↻
      </button>
    </div>

    <div *ngIf="eventsLoading" class="mt-3 text-sm text-brand-500">Loading events...</div>
    <div *ngIf="eventsError" class="mt-3 text-sm text-danger-700">{{ eventsError }}</div>

    <div
      class="touch-carousel mt-4 flex snap-x snap-mandatory gap-3 overflow-x-auto pb-1 sm:grid sm:grid-cols-2 sm:overflow-visible sm:pb-0 lg:grid-cols-3"
      *ngIf="!eventsLoading && upcomingEvents().length > 0"
    >
      <button
        type="button"
        *ngFor="let e of upcomingEvents()"
        class="min-w-[calc(50%-0.375rem)] snap-start rounded-2xl border border-brand-100 bg-white p-4 text-left shadow-sm sm:min-w-0"
        [ngClass]="{
          'border-2 border-brand-900 bg-brand-50': isSelectedEvent(e.eventDate),
          'bg-accent-50 border-accent-300': !isSelectedEvent(e.eventDate) && isThisWeek(e.eventDate)
        }"
        (click)="selectEvent(e.eventDate)"
      >
        <div class="text-xl font-semibold text-brand-900">{{ formatEventDate(e.eventDate) }}</div>
        <div class="text-xs text-brand-500">{{ e.eventDate }}</div>
        <div class="mt-2 text-sm font-semibold text-brand-900">{{ e.eventName }}</div>
        <div class="mt-1 text-[11px] uppercase tracking-[0.2em] text-brand-500">{{ e.status || 'ACTIVE' }}</div>
      </button>
    </div>

    <div class="mt-4 h-px w-full bg-brand-100"></div>

    <p class="mt-3 text-xs uppercase tracking-[0.16em] text-brand-500">Manual Date Lookup</p>
    <div class="grid gap-3 md:grid-cols-[1fr_auto_auto] md:items-end">
      <label class="grid gap-2 text-xs font-semibold uppercase tracking-[0.18em] text-brand-500">
        Event Date
        <input
          type="date"
          [formControl]="filterDate"
          class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900"
        />
      </label>
      <button
        type="button"
        class="h-11 rounded-lg bg-brand-900 px-4 text-sm font-semibold text-white"
        (click)="load()"
      >
        Load
      </button>
      <button
        type="button"
        class="h-11 rounded-lg border border-brand-200 px-4 text-sm text-brand-700"
        (click)="filterDate.setValue(''); items = []"
      >
        Clear
      </button>
    </div>

    <div *ngIf="loading" class="mt-4 text-sm text-brand-500">Loading...</div>
    <div *ngIf="!loading && items.length === 0" class="mt-4 text-sm text-brand-500">No reservations.</div>
    <p class="mt-4 text-sm text-danger-700" *ngIf="error">{{ error }}</p>

    <div class="mt-4 hidden overflow-x-auto lg:block" *ngIf="items.length > 0">
      <table class="w-full border-collapse text-left text-sm text-brand-900">
        <thead class="border-b border-brand-100 text-xs uppercase tracking-[0.16em] text-brand-500">
          <tr>
            <th class="py-3 pr-3">Reservation</th>
            <th class="py-3 pr-3">Payment</th>
            <th class="py-3 pr-3">Remaining</th>
            <th class="py-3 pr-3">Deadline</th>
            <th class="py-3 pr-3">Updated</th>
            <th class="py-3 pr-3">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let r of items"
            class="cursor-pointer border-b border-brand-100 transition-colors hover:bg-brand-50 last:border-0 focus-within:bg-brand-50"
            tabindex="0"
            role="button"
            (click)="onReservationRowClick(r)"
            (keydown)="onReservationRowKeydown($event, r)"
          >
            <td class="py-3 pr-3">
              <p class="font-semibold text-brand-900">Table {{ r.tableId }} · {{ r.customerName }}</p>
              <p class="text-xs text-brand-500">{{ reservationListMeta(r) }}</p>
            </td>
            <td class="py-3 pr-3">
              <span
                class="inline-flex rounded-full border px-2 py-0.5 text-[11px] font-semibold"
                [ngClass]="paymentStatusBadgeClass(r)"
              >
                {{ paymentStatusLabel(r) }}
              </span>
            </td>
            <td class="py-3 pr-3 font-semibold text-brand-900">${{ remainingDisplayAmount(r) | number:'1.2-2' }}</td>
            <td class="py-3 pr-3">{{ formatDeadline(r.paymentDeadlineAt, r.eventDate) }}</td>
            <td class="py-3 pr-3 text-xs text-brand-500">
              <ng-container *ngIf="(r.updatedAt || r.createdAt) as rowEpoch; else noRowEpoch">
                {{ rowEpoch * 1000 | date:'MMM d, h:mm a' }}
              </ng-container>
              <ng-template #noRowEpoch>—</ng-template>
            </td>
            <td class="py-3 pr-3" (click)="$event.stopPropagation()">
              <button
                type="button"
                class="rounded-lg bg-brand-900 px-3 py-1.5 text-xs font-semibold text-white disabled:cursor-not-allowed disabled:opacity-50"
                (click)="onTakePaymentFromList($event, r)"
                [disabled]="!canTakePayment(r)"
              >
                Take Payment
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="mt-4 grid gap-3 lg:hidden" *ngIf="items.length > 0">
      <article
        class="cursor-pointer rounded-xl border border-brand-100 bg-white p-4 shadow-sm transition-colors hover:bg-brand-50"
        *ngFor="let r of items"
        tabindex="0"
        role="button"
        (click)="onReservationRowClick(r)"
        (keydown)="onReservationRowKeydown($event, r)"
      >
        <div class="flex items-center justify-between gap-3">
          <p class="text-base font-semibold text-brand-900">Table {{ r.tableId }} · {{ r.customerName }}</p>
          <span
            class="inline-flex rounded-full border px-2 py-0.5 text-[11px] font-semibold"
            [ngClass]="paymentStatusBadgeClass(r)"
          >
            {{ paymentStatusLabel(r) }}
          </span>
        </div>
        <div class="mt-2 grid gap-1 text-sm text-brand-700">
          <div class="flex justify-between">
            <span class="text-brand-500">Remaining</span>
            <span class="font-semibold">${{ remainingDisplayAmount(r) | number:'1.2-2' }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-brand-500">Deadline</span>
            <span>{{ formatDeadline(r.paymentDeadlineAt, r.eventDate) }}</span>
          </div>
          <p class="text-xs text-brand-500">{{ reservationListMeta(r) }}</p>
        </div>
        <div class="mt-3 flex flex-wrap gap-2" (click)="$event.stopPropagation()">
          <button
            type="button"
            class="h-10 rounded-lg bg-brand-900 px-3 text-sm font-semibold text-white disabled:cursor-not-allowed disabled:opacity-50"
            (click)="onTakePaymentFromList($event, r)"
            [disabled]="!canTakePayment(r)"
          >
            Take Payment
          </button>
        </div>
      </article>
    </div>
  </section>
</section>

<div class="fixed inset-0 z-[200] flex items-center justify-center" *ngIf="showDetailsModal && detailItem">
  <div class="absolute inset-0 bg-black/40" (click)="closeDetails()"></div>
  <section class="relative h-[92dvh] w-[94vw] max-w-2xl overflow-y-auto overflow-x-hidden rounded-2xl bg-white p-4 md:h-auto md:max-h-[92dvh] md:p-6">
    <div class="flex items-start justify-between gap-3">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.16em] text-brand-500">Reservation</p>
        <h3 class="text-xl font-semibold text-brand-900">Table {{ detailItem.tableId }}</h3>
        <p class="break-words text-sm text-brand-600">{{ detailItem.customerName }} · {{ detailItem.phone | phoneDisplay }}</p>
      </div>
      <button
        type="button"
        class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-brand-200 text-xs text-brand-700"
        (click)="closeDetails()"
        aria-label="Close details"
      >
        ✕
      </button>
    </div>

    <div class="mt-4 grid grid-cols-2 gap-2">
      <article class="rounded-xl border border-brand-100 bg-brand-50 px-3 py-2">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Status</p>
        <p class="text-sm font-semibold text-brand-900">{{ detailItem.status }}</p>
      </article>
      <article class="rounded-xl border border-brand-100 bg-brand-50 px-3 py-2">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Payment</p>
        <p class="text-sm font-semibold text-brand-900">{{ detailItem.paymentStatus || '—' }}</p>
      </article>
      <article class="rounded-xl border border-brand-100 bg-brand-50 px-3 py-2">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Deposit</p>
        <p class="text-sm font-semibold text-brand-900">${{ detailItem.depositAmount }}</p>
      </article>
      <article class="rounded-xl border border-brand-100 bg-brand-50 px-3 py-2">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Amount Due</p>
        <p class="text-sm font-semibold text-brand-900">${{ detailItem.amountDue ?? 0 }}</p>
      </article>
    </div>

    <div class="mt-4 grid gap-3">
      <article class="rounded-xl border border-brand-100 p-3">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Payment Info</p>
        <dl class="mt-2 grid gap-2 text-sm text-brand-800">
          <div class="flex items-center justify-between gap-3">
            <dt class="text-brand-500">Method</dt>
            <dd class="font-medium text-brand-900">{{ detailItem.paymentMethod | paymentMethodLabel }}</dd>
          </div>
          <div class="flex items-center justify-between gap-3">
            <dt class="text-brand-500">Deadline</dt>
            <dd class="font-medium text-brand-900">{{ formatDeadline(detailItem.paymentDeadlineAt, detailItem.eventDate) }}</dd>
          </div>
        </dl>
      </article>

      <article class="rounded-xl border border-brand-100 p-3" *ngIf="canGeneratePaymentLink(detailItem)">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Payment Links</p>
        <div class="mt-2 grid gap-2 md:grid-cols-2">
          <section class="rounded-lg border border-brand-100 bg-brand-50 p-2">
            <p class="text-[11px] font-semibold uppercase tracking-[0.12em] text-brand-600">Square</p>
            <div class="mt-2 flex flex-wrap gap-2">
              <button
                type="button"
                class="h-8 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800 disabled:cursor-not-allowed disabled:opacity-50"
                [disabled]="paymentLinkLoadingId === detailItem.reservationId || publicPayLinkLoadingId === detailItem.reservationId || !canGeneratePaymentLink(detailItem)"
                (click)="generatePaymentLink(detailItem)"
              >
                {{ paymentLinkLoadingId === detailItem.reservationId ? 'Generating…' : 'Generate Square Link' }}
              </button>
            </div>
          </section>

          <section class="rounded-lg border border-brand-100 bg-brand-50 p-2">
            <p class="text-[11px] font-semibold uppercase tracking-[0.12em] text-brand-600">Cash App</p>
            <div class="mt-2 flex flex-wrap gap-2">
              <button
                type="button"
                class="h-8 rounded-lg bg-brand-900 px-3 text-xs font-semibold text-white disabled:cursor-not-allowed disabled:opacity-50"
                [disabled]="publicPayLinkLoadingId === detailItem.reservationId || paymentLinkLoadingId === detailItem.reservationId || !canGeneratePaymentLink(detailItem)"
                (click)="generateClientPayLink(detailItem)"
              >
                {{ publicPayLinkLoadingId === detailItem.reservationId ? 'Generating…' : 'Generate Cash App Link' }}
              </button>
            </div>
          </section>
        </div>

        <p class="mt-2 text-xs text-danger-700" *ngIf="paymentLinkError">{{ paymentLinkError }}</p>
        <p class="mt-2 text-xs text-success-700" *ngIf="paymentLinkNotice">{{ paymentLinkNotice }}</p>

        <div class="mt-2 rounded-lg border border-brand-100 bg-brand-50 p-2" *ngIf="getPaymentLinkSmsState(detailItem) as smsState">
          <div class="flex flex-wrap items-center gap-2">
            <span class="inline-flex rounded-full border px-2 py-0.5 text-[11px] font-semibold" [ngClass]="paymentLinkSmsBadgeClass(smsState.status)">
              {{ smsState.status === 'SENT' ? 'SMS SENT' : 'SMS FAILED' }}
            </span>
            <span class="text-xs text-brand-600">{{ smsState.atMs | date:'short' }}</span>
          </div>
          <p class="mt-1 text-xs text-brand-700" *ngIf="smsState.to">To {{ smsState.to }}</p>
          <p class="mt-1 break-all text-xs text-danger-700" *ngIf="smsState.errorMessage">{{ smsState.errorMessage }}</p>
        </div>

        <div class="mt-2 grid min-w-0 gap-2" *ngIf="getPaymentLink(detailItem) as paymentLink">
          <p class="text-xs text-brand-600">
            {{ paymentLink.method === 'cashapp' ? 'Cash App' : 'Square' }} link · Generated {{ paymentLink.createdAtMs | date:'shortTime' }} · ${{ paymentLink.amount | number:'1.2-2' }}
          </p>
          <input
            type="text"
            class="h-10 w-full min-w-0 rounded-lg border border-brand-200 px-3 text-xs text-brand-900"
            [value]="paymentLink.url"
            readonly
          />
          <div class="flex flex-wrap gap-2">
            <button
              type="button"
              class="h-9 rounded-lg border border-warning-300 bg-warning-50 px-3 text-xs font-semibold text-warning-800 disabled:cursor-not-allowed disabled:opacity-50"
              [disabled]="(paymentLink.method === 'square' ? paymentLinkLoadingId === detailItem.reservationId : publicPayLinkLoadingId === detailItem.reservationId) || !canGeneratePaymentLink(detailItem)"
              (click)="sendGeneratedLinkSms(detailItem, paymentLink.method)"
            >
              {{
                (paymentLink.method === 'square' ? paymentLinkLoadingId === detailItem.reservationId : publicPayLinkLoadingId === detailItem.reservationId)
                  ? 'Sending…'
                  : 'Send via FF SMS'
              }}
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="copyPaymentLink(detailItem)"
            >
              Copy
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="openSmsShare(detailItem)"
            >
              SMS App
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="openWhatsAppShare(detailItem)"
            >
              WhatsApp
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="sharePaymentLink(detailItem)"
            >
              Share
            </button>
          </div>
        </div>
      </article>

      <article class="rounded-xl border border-brand-100 p-3">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Check-In Pass</p>
          <button
            type="button"
            class="h-8 shrink-0 rounded-lg bg-brand-900 px-3 text-xs font-semibold text-white disabled:cursor-not-allowed disabled:opacity-50"
            [disabled]="checkInPassLoadingId === detailItem.reservationId || !canReissueCheckInPass(detailItem)"
            (click)="reissueCheckInPass(detailItem)"
          >
            {{ checkInPassLoadingId === detailItem.reservationId ? 'Reissuing…' : 'Reissue Pass' }}
          </button>
        </div>

        <p class="mt-2 text-xs text-brand-500" *ngIf="!canManageCheckInPass(detailItem)">
          Pass is available only for confirmed and fully paid reservations.
        </p>
        <p class="mt-2 text-xs text-brand-500" *ngIf="canManageCheckInPass(detailItem) && !canReissueCheckInPass(detailItem)">
          Reservation is already checked in. Reissue is disabled.
        </p>

        <div class="mt-2 rounded-lg border border-brand-100 bg-brand-50 p-2" *ngIf="getCheckInPassState(detailItem) as state">
          <div class="flex flex-wrap items-center gap-2">
            <span class="inline-flex rounded-full border px-2 py-0.5 text-[11px] font-semibold" [ngClass]="checkInStateBadgeClass(state.status)">
              {{ checkInStateLabel(state.status) }}
            </span>
            <span class="text-xs text-brand-600" *ngIf="epochSecondsToMs(state.usedAt) as usedAtMs">
              {{ usedAtMs | date:'short' }}
            </span>
          </div>
          <p class="mt-1 text-xs text-brand-700" *ngIf="state.usedBy">By {{ state.usedBy | systemActorLabel }}</p>
          <p class="mt-1 text-xs text-brand-700" *ngIf="state.revokedBy">Revoked by {{ state.revokedBy | systemActorLabel }}</p>
        </div>

        <p class="mt-2 text-xs text-danger-700" *ngIf="checkInPassError">{{ checkInPassError }}</p>
        <p class="mt-2 text-xs text-success-700" *ngIf="checkInPassNotice">{{ checkInPassNotice }}</p>

        <div class="mt-2 grid min-w-0 gap-2" *ngIf="getCheckInPass(detailItem) as pass">
          <p class="break-all text-xs text-brand-600">Pass {{ pass.passId }} · Updated {{ pass.createdAtMs | date:'shortTime' }}</p>
          <input
            type="text"
            class="h-10 w-full min-w-0 rounded-lg border border-brand-200 px-3 text-xs text-brand-900"
            [value]="pass.url"
            readonly
          />
          <div class="flex flex-wrap gap-2">
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="copyCheckInPassLink(detailItem)"
            >
              Copy
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="openSmsShareCheckInPass(detailItem)"
            >
              SMS
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="openWhatsAppShareCheckInPass(detailItem)"
            >
              WhatsApp
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="shareCheckInPassLink(detailItem)"
            >
              Share
            </button>
          </div>
          <p class="break-all text-xs text-brand-500">{{ checkInPassShareMessage(detailItem) }}</p>
        </div>
      </article>

      <details class="rounded-xl border border-brand-100 bg-white p-3">
        <summary class="cursor-pointer text-sm font-semibold text-brand-900">Activity Log</summary>

        <p class="mt-2 text-xs text-brand-500" *ngIf="historyLoadingId === detailItem.reservationId">Loading history…</p>
        <p class="mt-2 text-xs text-danger-700" *ngIf="historyError">{{ historyError }}</p>

        <div class="mt-3 grid gap-2" *ngIf="getHistory(detailItem) as historyItems">
          <p class="text-xs text-brand-500" *ngIf="historyItems.length === 0 && historyLoadingId !== detailItem.reservationId">
            No history yet for this reservation.
          </p>

          <article class="rounded-lg border border-brand-100 bg-brand-50 p-2" *ngFor="let h of historyItems">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <p class="text-xs font-semibold text-brand-900">{{ historyEventLabel(h.eventType) }}</p>
                <p class="mt-0.5 text-[11px] text-brand-600" *ngIf="historySummary(h) as summary">{{ summary }}</p>
                <p class="mt-0.5 text-[11px] text-brand-500">By {{ h.actor | systemActorLabel }}</p>
              </div>
              <div class="text-right">
                <span class="inline-flex rounded-full border px-2 py-0.5 text-[10px] font-semibold" [ngClass]="historyEventBadgeClass(h.eventType)">
                  {{ historyEventLabel(h.eventType) }}
                </span>
                <p class="mt-1 text-[11px] text-brand-500">{{ h.atMs | date:'short' }}</p>
              </div>
            </div>
          </article>
        </div>
      </details>

      <article class="rounded-xl border border-brand-100 p-3">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Audit</p>
        <dl class="mt-2 grid gap-2 text-sm text-brand-800">
          <div class="flex items-center justify-between gap-3">
            <dt class="text-brand-500">Created By</dt>
            <dd class="font-medium text-brand-900">{{ detailItem.createdBy || '—' }}</dd>
          </div>
          <div class="flex items-start justify-between gap-3">
            <dt class="text-brand-500">Cancel Reason</dt>
            <dd class="max-w-[70%] text-right font-medium text-brand-900">{{ detailItem.cancelReason || '—' }}</dd>
          </div>
        </dl>
      </article>

      <article class="rounded-xl border border-brand-100 p-3">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Reservation Status</p>
          <button
            type="button"
            class="h-8 rounded-lg border border-danger-200 px-3 text-xs font-semibold text-danger-700 disabled:cursor-not-allowed disabled:opacity-50"
            [disabled]="!canCancelReservation(detailItem)"
            (click)="cancel(detailItem)"
          >
            Cancel Reservation
          </button>
        </div>
        <p class="mt-2 text-xs text-brand-500" *ngIf="isPastEvent(detailItem)">
          Past event reservation: payments and cancellation are disabled.
        </p>
      </article>
    </div>
  </section>
</div>

<div class="fixed inset-0 z-[200] flex items-center justify-center" *ngIf="showPaymentModal && paymentItem">
  <div class="absolute inset-0 bg-black/40" (click)="closePayment()"></div>
  <section class="relative max-h-[92dvh] w-[92vw] max-w-md overflow-y-auto overflow-x-hidden rounded-2xl bg-white p-4 md:p-6">
    <div class="flex items-center justify-between gap-3">
      <h3 class="text-lg font-semibold text-brand-900">Take Payment</h3>
      <button
        type="button"
        class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-brand-200 text-xs text-brand-700"
        (click)="closePayment()"
        aria-label="Close payment modal"
      >
        ✕
      </button>
    </div>
    <p class="mt-2 text-sm text-brand-600">Table {{ paymentItem.tableId }} · {{ paymentItem.customerName }}</p>
    <form class="mt-4 grid gap-3" [formGroup]="paymentForm" (ngSubmit)="submitPayment()">
      <label class="grid gap-1 text-xs uppercase tracking-[0.12em] text-brand-500">
        Amount
        <input
          type="number"
          min="0.01"
          step="0.01"
          formControlName="amount"
          [readonly]="isCreditPaymentMethodSelected()"
          class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900 readonly:bg-brand-50"
        />
      </label>
      <label class="grid gap-1 text-xs uppercase tracking-[0.12em] text-brand-500">
        Method
        <select
          formControlName="method"
          (change)="onPaymentMethodChanged()"
          class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900"
        >
          <option value="square">Square</option>
          <option value="cashapp">Cash App Pay</option>
          <option value="cash">Cash</option>
          <option value="credit">Reservation Credit</option>
        </select>
      </label>
      <div class="grid gap-2" *ngIf="isCreditPaymentMethodSelected()">
        <label class="grid gap-1 text-xs uppercase tracking-[0.12em] text-brand-500">
          Available Credit
          <select
            formControlName="creditId"
            (change)="onPaymentCreditChanged()"
            class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900 disabled:bg-brand-50"
            [disabled]="paymentCreditsLoading || !paymentCredits.length"
          >
            <option value="" disabled selected hidden>Select reservation credit</option>
            <option *ngFor="let credit of paymentCredits" [value]="credit.creditId">
              {{ creditOptionLabel(credit) }}
            </option>
          </select>
        </label>
        <p class="text-xs text-brand-600" *ngIf="paymentCreditsLoading">Loading reservation credits…</p>
        <p class="text-xs text-danger-700" *ngIf="paymentCreditsError">{{ paymentCreditsError }}</p>
        <div class="rounded-lg border border-brand-100 bg-brand-50 p-2 text-xs text-brand-700" *ngIf="!paymentCreditsLoading && paymentCredits.length">
          <p>Credit applied now: ${{ creditAppliedAmount().toFixed(2) }}</p>
          <p *ngIf="creditRemainingAmount() > 0">Remaining after credit: ${{ creditRemainingAmount().toFixed(2) }}</p>
        </div>
      </div>
      <label class="grid gap-1 text-xs uppercase tracking-[0.12em] text-brand-500" *ngIf="shouldShowRemainingMethodSelector()">
        Remaining Payment Method
        <select
          formControlName="remainingMethod"
          (change)="onRemainingMethodChanged()"
          class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900"
        >
          <option value="cash">Cash</option>
          <option value="square">Square</option>
        </select>
      </label>
      <label class="grid gap-1 text-xs uppercase tracking-[0.12em] text-brand-500" *ngIf="shouldShowCashReceiptField()">
        {{ cashReceiptLabel() }}
        <input
          type="text"
          formControlName="receiptNumber"
          (input)="onReceiptNumberInput()"
          inputmode="numeric"
          pattern="[0-9]*"
          enterkeyhint="done"
          autocapitalize="off"
          spellcheck="false"
          maxlength="64"
          autocomplete="off"
          placeholder="Enter receipt number"
          class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900"
        />
      </label>
      <p class="text-xs text-danger-700" *ngIf="shouldShowCashReceiptError()">
        Receipt number is required for cash payments.
      </p>
      <label class="grid gap-1 text-xs uppercase tracking-[0.12em] text-brand-500">
        Note
        <input type="text" formControlName="note" class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900" />
      </label>

      <p class="text-xs text-brand-600" *ngIf="isSquarePaymentMethodSelected()">
        Square in this modal generates a Square link. Reader charge can be added later.
      </p>
      <p class="text-xs text-brand-600" *ngIf="isCashAppPaymentMethodSelected()">
        Tap "Show Cash App QR", then have the client scan and approve on their own phone.
      </p>
      <div class="rounded-lg border border-brand-100 bg-brand-50 p-2" *ngIf="isCashAppPaymentMethodSelected()">
        <div #cashAppPayHost class="min-h-[140px]"></div>
        <p class="mt-2 text-xs text-brand-600" *ngIf="cashAppPayReady">
          QR ready. Waiting for client approval.
        </p>
      </div>
      <p class="text-xs text-danger-700" *ngIf="isCashAppPaymentMethodSelected() && !canUseCashAppPay()">
        Cash App Pay is not configured. Set Square application id and location id in Lambda env vars.
      </p>
      <p class="text-xs text-danger-700" *ngIf="paymentLinkError && isSquarePaymentMethodSelected()">{{ paymentLinkError }}</p>
      <p class="text-xs text-danger-700" *ngIf="paymentLinkError && isCashAppPaymentMethodSelected()">{{ paymentLinkError }}</p>

      <button
        type="submit"
        class="h-11 rounded-lg bg-brand-900 text-sm font-semibold text-white disabled:opacity-50"
        [disabled]="
          isSquarePaymentMethodSelected()
            ? paymentLinkLoadingId === paymentItem.reservationId || !canGeneratePaymentLink(paymentItem)
            : loading ||
              cashAppPayPreparing ||
              paymentForm.invalid ||
              (isCashAppPaymentMethodSelected() && !canUseCashAppPay()) ||
              (isCreditPaymentMethodSelected() &&
                (paymentCreditsLoading ||
                  !paymentForm.controls.creditId.value ||
                  (shouldShowRemainingMethodSelector() && !paymentForm.controls.remainingMethod.value)))
        "
      >
        {{ paymentSubmitLabel() }}
      </button>
    </form>
  </section>
</div>
