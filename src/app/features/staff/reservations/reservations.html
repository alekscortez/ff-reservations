<section class="flex w-full flex-col gap-4">
  <header>
    <h1 class="text-2xl font-semibold text-brand-900">Reservations</h1>
    <p class="text-sm text-brand-600">View and manage reservations by date.</p>
  </header>

  <section class="w-full rounded-2xl border border-brand-100 bg-white p-4 md:p-6">
    <div class="flex items-center justify-between gap-3">
      <h2 class="text-lg font-semibold text-brand-900">Select Event</h2>
      <button
        type="button"
        class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-brand-200 text-brand-700"
        (click)="loadEvents()"
        [disabled]="eventsLoading"
        aria-label="Refresh events"
        title="Refresh events"
      >
        ↻
      </button>
    </div>

    <div *ngIf="eventsLoading" class="mt-3 text-sm text-brand-500">Loading events...</div>
    <div *ngIf="eventsError" class="mt-3 text-sm text-danger-700">{{ eventsError }}</div>

    <div
      class="touch-carousel mt-4 flex snap-x snap-mandatory gap-3 overflow-x-auto pb-1 sm:grid sm:grid-cols-2 sm:overflow-visible sm:pb-0 lg:grid-cols-3"
      *ngIf="!eventsLoading && upcomingEvents().length > 0"
    >
      <button
        type="button"
        *ngFor="let e of upcomingEvents()"
        class="min-w-[calc(50%-0.375rem)] snap-start rounded-2xl border border-brand-100 bg-white p-4 text-left shadow-sm sm:min-w-0"
        [ngClass]="{
          'border-2 border-brand-900 bg-brand-50': isSelectedEvent(e.eventDate),
          'bg-accent-50 border-accent-300': !isSelectedEvent(e.eventDate) && isThisWeek(e.eventDate)
        }"
        (click)="selectEvent(e.eventDate)"
      >
        <div class="text-xl font-semibold text-brand-900">{{ formatEventDate(e.eventDate) }}</div>
        <div class="text-xs text-brand-500">{{ e.eventDate }}</div>
        <div class="mt-2 text-sm font-semibold text-brand-900">{{ e.eventName }}</div>
        <div class="mt-1 text-[11px] uppercase tracking-[0.2em] text-brand-500">{{ e.status || 'ACTIVE' }}</div>
      </button>
    </div>

    <div class="mt-4 h-px w-full bg-brand-100"></div>

    <p class="mt-3 text-xs uppercase tracking-[0.16em] text-brand-500">Manual Date Lookup</p>
    <div class="grid gap-3 md:grid-cols-[1fr_auto_auto] md:items-end">
      <label class="grid gap-2 text-xs font-semibold uppercase tracking-[0.18em] text-brand-500">
        Event Date
        <input
          type="date"
          [formControl]="filterDate"
          class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900"
        />
      </label>
      <button
        type="button"
        class="h-11 rounded-lg bg-brand-900 px-4 text-sm font-semibold text-white"
        (click)="load()"
      >
        Load
      </button>
      <button
        type="button"
        class="h-11 rounded-lg border border-brand-200 px-4 text-sm text-brand-700"
        (click)="filterDate.setValue(''); items = []"
      >
        Clear
      </button>
    </div>

    <div *ngIf="loading" class="mt-4 text-sm text-brand-500">Loading...</div>
    <div *ngIf="!loading && items.length === 0" class="mt-4 text-sm text-brand-500">No reservations.</div>
    <p class="mt-4 text-sm text-danger-700" *ngIf="error">{{ error }}</p>

    <div class="mt-4 hidden overflow-x-auto lg:block" *ngIf="items.length > 0">
      <table class="w-full border-collapse text-left text-sm text-brand-900">
        <thead class="border-b border-brand-100 text-xs uppercase tracking-[0.16em] text-brand-500">
          <tr>
            <th class="py-3 pr-3">Table</th>
            <th class="py-3 pr-3">Customer</th>
            <th class="py-3 pr-3">Status</th>
            <th class="py-3 pr-3">Payment</th>
            <th class="py-3 pr-3">Amount Due</th>
            <th class="py-3 pr-3">Deadline</th>
            <th class="py-3 pr-3">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of items" class="border-b border-brand-100 last:border-0">
            <td class="py-3 pr-3 font-semibold">{{ r.tableId }}</td>
            <td class="py-3 pr-3">{{ r.customerName }}</td>
            <td class="py-3 pr-3">{{ r.status }}</td>
            <td class="py-3 pr-3">{{ r.paymentStatus || '—' }}</td>
            <td class="py-3 pr-3">${{ r.amountDue ?? 0 }}</td>
            <td class="py-3 pr-3">{{ formatDeadline(r.paymentDeadlineAt, r.eventDate) }}</td>
            <td class="py-3 pr-3">
              <div class="flex flex-wrap gap-2">
                <button
                  type="button"
                  class="rounded-lg border border-brand-200 px-3 py-1.5 text-xs font-semibold text-brand-800"
                  (click)="openDetails(r)"
                >
                  Details
                </button>
                <button
                  type="button"
                  class="rounded-lg bg-brand-900 px-3 py-1.5 text-xs font-semibold text-white disabled:cursor-not-allowed disabled:opacity-50"
                  (click)="openPayment(r)"
                  [disabled]="r.status !== 'CONFIRMED' || r.paymentStatus === 'PAID' || r.paymentStatus === 'COURTESY'"
                >
                  Take Payment
                </button>
                <button
                  type="button"
                  class="rounded-lg border border-brand-200 px-3 py-1.5 text-xs font-semibold text-brand-800 disabled:cursor-not-allowed disabled:opacity-50"
                  (click)="cancel(r)"
                  [disabled]="r.status !== 'CONFIRMED'"
                >
                  Cancel
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="mt-4 grid gap-3 lg:hidden" *ngIf="items.length > 0">
      <article class="rounded-xl border border-brand-100 bg-white p-4 shadow-sm" *ngFor="let r of items">
        <div class="flex items-center justify-between gap-3">
          <div class="text-lg font-semibold text-brand-900">{{ r.tableId }}</div>
          <div class="text-xs font-semibold uppercase tracking-[0.15em] text-brand-500">{{ r.status }}</div>
        </div>
        <div class="mt-2 text-sm text-brand-800">{{ r.customerName }} · {{ r.phone | phoneDisplay }}</div>
        <div class="mt-3 grid gap-1 text-sm text-brand-700">
          <div class="flex justify-between"><span class="text-brand-500">Payment</span><span>{{ r.paymentStatus || '—' }}</span></div>
          <div class="flex justify-between"><span class="text-brand-500">Amount Due</span><span>${{ r.amountDue ?? 0 }}</span></div>
          <div class="flex justify-between"><span class="text-brand-500">Deadline</span><span>{{ formatDeadline(r.paymentDeadlineAt, r.eventDate) }}</span></div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          <button
            type="button"
            class="h-10 rounded-lg border border-brand-200 px-3 text-sm font-semibold text-brand-800"
            (click)="openDetails(r)"
          >
            Details
          </button>
          <button
            type="button"
            class="h-10 rounded-lg bg-brand-900 px-3 text-sm font-semibold text-white disabled:cursor-not-allowed disabled:opacity-50"
            (click)="openPayment(r)"
            [disabled]="r.status !== 'CONFIRMED' || r.paymentStatus === 'PAID' || r.paymentStatus === 'COURTESY'"
          >
            Take Payment
          </button>
          <button
            type="button"
            class="h-10 rounded-lg border border-brand-200 px-3 text-sm font-semibold text-brand-800 disabled:cursor-not-allowed disabled:opacity-50"
            (click)="cancel(r)"
            [disabled]="r.status !== 'CONFIRMED'"
          >
            Cancel
          </button>
        </div>
      </article>
    </div>
  </section>
</section>

<div class="fixed inset-0 z-50 flex items-center justify-center" *ngIf="showDetailsModal && detailItem">
  <div class="absolute inset-0 bg-black/40" (click)="closeDetails()"></div>
  <section class="relative h-[92dvh] w-[94vw] max-w-2xl overflow-auto rounded-2xl bg-white p-4 md:h-auto md:p-6">
    <div class="flex items-start justify-between gap-3">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.16em] text-brand-500">Reservation</p>
        <h3 class="text-xl font-semibold text-brand-900">Table {{ detailItem.tableId }}</h3>
        <p class="text-sm text-brand-600">{{ detailItem.customerName }} · {{ detailItem.phone | phoneDisplay }}</p>
      </div>
      <button
        type="button"
        class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-brand-200 text-xs text-brand-700"
        (click)="closeDetails()"
        aria-label="Close details"
      >
        ✕
      </button>
    </div>

    <div class="mt-4 grid grid-cols-2 gap-2">
      <article class="rounded-xl border border-brand-100 bg-brand-50 px-3 py-2">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Status</p>
        <p class="text-sm font-semibold text-brand-900">{{ detailItem.status }}</p>
      </article>
      <article class="rounded-xl border border-brand-100 bg-brand-50 px-3 py-2">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Payment</p>
        <p class="text-sm font-semibold text-brand-900">{{ detailItem.paymentStatus || '—' }}</p>
      </article>
      <article class="rounded-xl border border-brand-100 bg-brand-50 px-3 py-2">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Deposit</p>
        <p class="text-sm font-semibold text-brand-900">${{ detailItem.depositAmount }}</p>
      </article>
      <article class="rounded-xl border border-brand-100 bg-brand-50 px-3 py-2">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Amount Due</p>
        <p class="text-sm font-semibold text-brand-900">${{ detailItem.amountDue ?? 0 }}</p>
      </article>
    </div>

    <div class="mt-4 grid gap-3">
      <article class="rounded-xl border border-brand-100 p-3">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Payment Info</p>
        <dl class="mt-2 grid gap-2 text-sm text-brand-800">
          <div class="flex items-center justify-between gap-3">
            <dt class="text-brand-500">Method</dt>
            <dd class="font-medium text-brand-900">{{ detailItem.paymentMethod || '—' }}</dd>
          </div>
          <div class="flex items-center justify-between gap-3">
            <dt class="text-brand-500">Deadline</dt>
            <dd class="font-medium text-brand-900">{{ formatDeadline(detailItem.paymentDeadlineAt, detailItem.eventDate) }}</dd>
          </div>
        </dl>
      </article>

      <article class="rounded-xl border border-brand-100 p-3">
        <div class="flex items-center justify-between gap-3">
          <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Payment Link</p>
          <button
            type="button"
            class="h-8 rounded-lg bg-brand-900 px-3 text-xs font-semibold text-white disabled:cursor-not-allowed disabled:opacity-50"
            [disabled]="paymentLinkLoadingId === detailItem.reservationId || !canGeneratePaymentLink(detailItem)"
            (click)="generatePaymentLink(detailItem)"
          >
            {{ paymentLinkLoadingId === detailItem.reservationId ? 'Generating…' : 'Generate Link' }}
          </button>
        </div>

        <p class="mt-2 text-xs text-brand-500" *ngIf="!canGeneratePaymentLink(detailItem)">
          Link is only available for confirmed pending/partial reservations.
        </p>

        <p class="mt-2 text-xs text-danger-700" *ngIf="paymentLinkError">{{ paymentLinkError }}</p>
        <p class="mt-2 text-xs text-success-700" *ngIf="paymentLinkNotice">{{ paymentLinkNotice }}</p>

        <div class="mt-2 grid gap-2" *ngIf="getPaymentLink(detailItem) as paymentLink">
          <p class="text-xs text-brand-600">
            Generated {{ paymentLink.createdAtMs | date:'shortTime' }} · ${{ paymentLink.amount | number:'1.2-2' }}
          </p>
          <input
            type="text"
            class="h-10 rounded-lg border border-brand-200 px-3 text-xs text-brand-900"
            [value]="paymentLink.url"
            readonly
          />
          <div class="flex flex-wrap gap-2">
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="copyPaymentLink(detailItem)"
            >
              Copy
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="openSmsShare(detailItem)"
            >
              SMS
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="openWhatsAppShare(detailItem)"
            >
              WhatsApp
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="sharePaymentLink(detailItem)"
            >
              Share
            </button>
          </div>
          <p class="text-xs text-brand-500">{{ paymentLinkShareMessage(detailItem) }}</p>
        </div>
      </article>

      <article class="rounded-xl border border-brand-100 p-3">
        <div class="flex items-center justify-between gap-3">
          <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Check-In Pass</p>
          <button
            type="button"
            class="h-8 rounded-lg bg-brand-900 px-3 text-xs font-semibold text-white disabled:cursor-not-allowed disabled:opacity-50"
            [disabled]="checkInPassLoadingId === detailItem.reservationId || !canManageCheckInPass(detailItem)"
            (click)="reissueCheckInPass(detailItem)"
          >
            {{ checkInPassLoadingId === detailItem.reservationId ? 'Reissuing…' : 'Reissue Pass' }}
          </button>
        </div>

        <p class="mt-2 text-xs text-brand-500" *ngIf="!canManageCheckInPass(detailItem)">
          Pass is available only for confirmed and fully paid reservations.
        </p>

        <p class="mt-2 text-xs text-danger-700" *ngIf="checkInPassError">{{ checkInPassError }}</p>
        <p class="mt-2 text-xs text-success-700" *ngIf="checkInPassNotice">{{ checkInPassNotice }}</p>

        <div class="mt-2 grid gap-2" *ngIf="getCheckInPass(detailItem) as pass">
          <p class="text-xs text-brand-600">Pass {{ pass.passId }} · Updated {{ pass.createdAtMs | date:'shortTime' }}</p>
          <input
            type="text"
            class="h-10 rounded-lg border border-brand-200 px-3 text-xs text-brand-900"
            [value]="pass.url"
            readonly
          />
          <div class="flex flex-wrap gap-2">
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="copyCheckInPassLink(detailItem)"
            >
              Copy
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="openSmsShareCheckInPass(detailItem)"
            >
              SMS
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="openWhatsAppShareCheckInPass(detailItem)"
            >
              WhatsApp
            </button>
            <button
              type="button"
              class="h-9 rounded-lg border border-brand-200 px-3 text-xs font-semibold text-brand-800"
              (click)="shareCheckInPassLink(detailItem)"
            >
              Share
            </button>
          </div>
          <p class="text-xs text-brand-500">{{ checkInPassShareMessage(detailItem) }}</p>
        </div>
      </article>

      <article class="rounded-xl border border-brand-100 p-3">
        <p class="text-[11px] uppercase tracking-[0.12em] text-brand-500">Audit</p>
        <dl class="mt-2 grid gap-2 text-sm text-brand-800">
          <div class="flex items-center justify-between gap-3">
            <dt class="text-brand-500">Created By</dt>
            <dd class="font-medium text-brand-900">{{ detailItem.createdBy || '—' }}</dd>
          </div>
          <div class="flex items-start justify-between gap-3">
            <dt class="text-brand-500">Cancel Reason</dt>
            <dd class="max-w-[70%] text-right font-medium text-brand-900">{{ detailItem.cancelReason || '—' }}</dd>
          </div>
        </dl>
      </article>
    </div>
  </section>
</div>

<div class="fixed inset-0 z-50 flex items-center justify-center" *ngIf="showPaymentModal && paymentItem">
  <div class="absolute inset-0 bg-black/40" (click)="closePayment()"></div>
  <section class="relative w-[92vw] max-w-md rounded-2xl bg-white p-4 md:p-6">
    <div class="flex items-center justify-between gap-3">
      <h3 class="text-lg font-semibold text-brand-900">Take Payment</h3>
      <button
        type="button"
        class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-brand-200 text-xs text-brand-700"
        (click)="closePayment()"
        aria-label="Close payment modal"
      >
        ✕
      </button>
    </div>
    <p class="mt-2 text-sm text-brand-600">Table {{ paymentItem.tableId }} · {{ paymentItem.customerName }}</p>
    <form class="mt-4 grid gap-3" [formGroup]="paymentForm" (ngSubmit)="submitPayment()">
      <label class="grid gap-1 text-xs uppercase tracking-[0.12em] text-brand-500">
        Amount
        <input type="number" min="0.01" step="0.01" formControlName="amount" class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900" />
      </label>
      <label class="grid gap-1 text-xs uppercase tracking-[0.12em] text-brand-500">
        Method
        <select formControlName="method" class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900">
          <option value="cash">Cash</option>
          <option value="cashapp">CashApp</option>
          <option value="square">Square</option>
        </select>
      </label>
      <label class="grid gap-1 text-xs uppercase tracking-[0.12em] text-brand-500">
        Note
        <input type="text" formControlName="note" class="h-11 rounded-lg border border-brand-200 px-3 text-sm text-brand-900 outline-none focus:border-brand-900" />
      </label>
      <button type="submit" class="h-11 rounded-lg bg-brand-900 text-sm font-semibold text-white disabled:opacity-50" [disabled]="loading || paymentForm.invalid">
        Submit Payment
      </button>
    </form>
  </section>
</div>
