<section class="page">
  <header class="page-header">
    <h1>Clients CRM</h1>
    <p>All customers who have reserved, with totals and last visit.</p>
  </header>

  <section class="card">
    <div class="filters">
      <label>
        Search
        <input type="text" [formControl]="filterQuery" placeholder="Name or phone" />
      </label>
      <button type="button" (click)="load()" [disabled]="loading">Refresh</button>
    </div>

    <div *ngIf="loading" class="muted">Loading…</div>
    <div *ngIf="!loading && filteredItems().length === 0" class="muted">No clients.</div>
    <p class="error" *ngIf="error">{{ error }}</p>

    <div class="table-wrap" *ngIf="filteredItems().length > 0">
      <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Total Spend</th>
          <th>Reservations</th>
          <th>Last Event</th>
          <th>Last Table</th>
          <th>Updated By</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let c of filteredItems()">
          <tr *ngIf="editingPhone !== c.phone">
            <td>{{ c.name }}</td>
            <td>{{ c.phone }}</td>
            <td>${{ formatMoney(c.totalSpend) }}</td>
            <td>{{ c.totalReservations || 0 }}</td>
            <td>{{ c.lastEventDate || '—' }}</td>
            <td>{{ c.lastTableId || '—' }}</td>
            <td>{{ c.updatedBy || '—' }}</td>
            <td class="actions">
              <button type="button" (click)="startEdit(c)">Edit</button>
              <button type="button" class="ghost danger" (click)="deleteClient(c)">
                Delete
              </button>
            </td>
          </tr>

          <tr *ngIf="editingPhone === c.phone">
            <td colspan="8">
              <form [formGroup]="editForm" (ngSubmit)="saveEdit()" class="edit-form">
                <label>
                  Name
                  <input type="text" formControlName="name" />
                </label>
                <label>
                  Phone
                  <input type="text" formControlName="phone" />
                </label>
                <div class="actions">
                  <button type="submit" [disabled]="loading">Save</button>
                  <button type="button" class="ghost" (click)="cancelEdit()" [disabled]="loading">
                    Cancel
                  </button>
                </div>
              </form>
            </td>
          </tr>
        </ng-container>
      </tbody>
      </table>
    </div>

    <div class="cards" *ngIf="filteredItems().length > 0">
      <div class="client-card" *ngFor="let c of filteredItems()">
        <div class="card-head">
          <div>
            <div class="name">{{ c.name }}</div>
            <div class="phone">{{ c.phone }}</div>
          </div>
          <div class="meta">
            <div>Total ${{ formatMoney(c.totalSpend) }}</div>
            <div>{{ c.totalReservations || 0 }} reservations</div>
          </div>
        </div>
        <div class="card-row">
          <span>Last Event</span>
          <span>{{ c.lastEventDate || '—' }}</span>
        </div>
        <div class="card-row">
          <span>Last Table</span>
          <span>{{ c.lastTableId || '—' }}</span>
        </div>
        <div class="card-row">
          <span>Updated By</span>
          <span>{{ c.updatedBy || '—' }}</span>
        </div>
        <div class="actions">
          <button type="button" (click)="startEdit(c)">Edit</button>
          <button type="button" class="ghost danger" (click)="deleteClient(c)">
            Delete
          </button>
        </div>
      </div>
    </div>
  </section>
</section>
