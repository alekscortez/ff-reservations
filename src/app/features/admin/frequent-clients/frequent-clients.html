<section class="page">
  <header class="page-header">
    <h1>Frequent Clients</h1>
    <p>Manage recurring guests and their default tables</p>
  </header>

  <section class="card" *ngIf="showCreateForm">
    <div class="card-head">
      <h2>Add Frequent Client</h2>
      <button type="button" class="ghost" (click)="toggleCreateForm()">
        Close
      </button>
    </div>
    <form class="create-form" [formGroup]="form" (ngSubmit)="create()">
      <div class="row">
        <label>
          Name
          <input type="text" formControlName="name" />
        </label>
        <label>
          Phone
          <input type="text" formControlName="phone" />
        </label>
        <label class="wide">
          Reserved Tables
          <div class="selected-tables">
            <span
              class="pill"
              *ngFor="let t of createSelectedTables"
              (click)="removeCreateTable(t)"
            >
              {{ t }}
            </span>
          </div>
        </label>
      </div>
      <div class="picker">
        <div class="section-tabs">
          <button
            type="button"
            *ngFor="let s of templateSections"
            class="tab"
            [class.active]="activeSection === s"
            (click)="toggleSection(s)"
          >
            Section {{ s }}
          </button>
        </div>
        <div class="tables-row">
          <button
            type="button"
            class="table-chip"
            *ngFor="let t of templateTablesBySection[activeSection]"
            [class.selected]="isCreateSelected(t.id)"
            (click)="toggleCreateTable(t.id)"
          >
            {{ t.id }}
          </button>
        </div>
      </div>
      <div class="settings" *ngIf="createSelectedList.length > 0">
        <div class="settings-row header">
          <span>Table</span>
          <span>Payment Status</span>
          <span>Amount Due</span>
          <span>Amount Paid</span>
          <span>Deadline</span>
        </div>
        <div class="settings-row" *ngFor="let tableId of createSelectedList">
          <ng-container *ngIf="getCreateSetting(tableId) as setting">
          <div class="table-meta">
            <strong>{{ tableId }}</strong>
            <small
              *ngIf="getTableInfo(tableId) as info"
              >Section {{ info.section }} · ${{ info.price }}</small
            >
          </div>
          <select
            [value]="setting.paymentStatus"
            (change)="updateCreateSetting(tableId, { paymentStatus: $any($event.target).value })"
          >
            <option
              *ngFor="let status of paymentStatuses"
              [value]="status"
              [selected]="status === setting.paymentStatus"
            >
              {{ status }}
            </option>
          </select>
          <ng-container *ngIf="setting.paymentStatus !== 'COURTESY'; else courtesyCreate">
            <input
              type="number"
              min="0"
              [value]="setting.amountDue"
              (input)="updateCreateSetting(tableId, { amountDue: toNumber($any($event.target).value) })"
            />
            <input
              type="number"
              min="0"
              [value]="setting.amountPaid ?? 0"
              [disabled]="
                setting.paymentStatus === 'PENDING' ||
                setting.paymentStatus === 'PAID'
              "
              (input)="updateCreateSetting(tableId, { amountPaid: toNumber($any($event.target).value) })"
            />
          </ng-container>
          <ng-template #courtesyCreate>
            <div class="courtesy-note">Courtesy table</div>
            <div class="courtesy-note muted">$0 due</div>
          </ng-template>
          <div
            class="deadline"
            *ngIf="
              setting.paymentStatus === 'PENDING' ||
              setting.paymentStatus === 'PARTIAL'
            "
          >
            <input
              type="time"
              [value]="setting.paymentDeadlineTime"
              (input)="updateCreateSetting(tableId, { paymentDeadlineTime: $any($event.target).value })"
            />
            <select
              [value]="setting.paymentDeadlineTz"
              (change)="updateCreateSetting(tableId, { paymentDeadlineTz: $any($event.target).value })"
            >
              <option value="America/Chicago">America/Chicago</option>
              <option value="UTC">UTC</option>
            </select>
          </div>
          </ng-container>
        </div>
      </div>
      <label>
        Notes
        <input type="text" formControlName="notes" />
      </label>
      <div class="actions">
        <button type="submit" [disabled]="form.invalid || loading">Create</button>
        <button type="button" class="ghost" (click)="toggleCreateForm()" [disabled]="loading">
          Cancel
        </button>
      </div>
    </form>
    <p class="error" *ngIf="error">{{ error }}</p>
  </section>

  <section class="card" *ngIf="!showCreateForm">
    <div class="card-head">
      <input
        type="text"
        class="search"
        placeholder="Search name, phone, or table"
        [formControl]="filterQuery"
      />
      <div class="actions">
        <button type="button" class="icon" (click)="load()" [disabled]="loading" title="Refresh">
          ↻
        </button>
        <button type="button" class="primary" (click)="toggleCreateForm()">
          + Add
        </button>
      </div>
    </div>
    <div *ngIf="loading" class="muted">Loading…</div>
    <div *ngIf="!loading && items.length === 0" class="muted">No clients yet.</div>

    <table *ngIf="filteredItems().length > 0">
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Reserved Tables</th>
          <th>Status</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let c of filteredItems()">
          <tr *ngIf="editingId !== c.clientId">
            <td>{{ c.name }}</td>
            <td>{{ c.phone }}</td>
            <td>{{ formatTables(c) }}</td>
            <td>{{ c.status }}</td>
            <td>{{ c.notes }}</td>
            <td class="actions">
              <button type="button" (click)="startEdit(c)">Edit</button>
              <button type="button" class="danger" (click)="delete(c)">Delete</button>
            </td>
          </tr>
          <tr *ngIf="editingId === c.clientId">
            <td colspan="6">
              <form [formGroup]="editForm" (ngSubmit)="saveEdit()" class="edit-form">
                <div class="row">
                  <label>
                    Name
                    <input type="text" formControlName="name" />
                  </label>
                  <label>
                    Phone
                    <input type="text" formControlName="phone" />
                  </label>
                  <label class="wide">
                    Reserved Tables
                    <div class="selected-tables">
                      <span
                        class="pill"
                        *ngFor="let t of editSelectedTables"
                        (click)="removeEditTable(t)"
                      >
                        {{ t }}
                      </span>
                    </div>
                  </label>
                </div>
                <div class="picker">
                  <div class="section-tabs">
                    <button
                      type="button"
                      *ngFor="let s of templateSections"
                      class="tab"
                      [class.active]="activeSection === s"
                      (click)="toggleSection(s)"
                    >
                      Section {{ s }}
                    </button>
                  </div>
                  <div class="tables-row">
                    <button
                      type="button"
                      class="table-chip"
                      *ngFor="let t of templateTablesBySection[activeSection]"
                      [class.selected]="isEditSelected(t.id)"
                      (click)="toggleEditTable(t.id)"
                    >
                      {{ t.id }}
                    </button>
                  </div>
                </div>
                <div class="settings" *ngIf="editSettings.length > 0">
                  <div class="settings-row header">
                    <span>Table</span>
                    <span>Payment Status</span>
                    <span>Amount Due</span>
                    <span>Amount Paid</span>
                    <span>Deadline</span>
                  </div>
                  <div
                    class="settings-row"
                    *ngFor="let group of editSettings.controls; let i = index"
                    [formGroup]="group"
                  >
                    <div class="table-meta">
                      <strong>{{ editTableIdAt(i) }}</strong>
                      <small
                        *ngIf="getTableInfo(editTableIdAt(i)) as info"
                        >Section {{ info.section }} · ${{ info.price }}</small
                      >
                    </div>
                    <select formControlName="paymentStatus">
                      <option
                        *ngFor="let status of paymentStatuses"
                        [value]="status"
                      >
                        {{ status }}
                      </option>
                    </select>
                    <ng-container *ngIf="!isEditCourtesy(i); else courtesyEdit">
                      <input
                        type="number"
                        min="0"
                        formControlName="amountDue"
                      />
                      <input
                        type="number"
                        min="0"
                        [disabled]="
                          editStatusAt(i) === 'PENDING' ||
                          editStatusAt(i) === 'PAID'
                        "
                        formControlName="amountPaid"
                      />
                    </ng-container>
                    <ng-template #courtesyEdit>
                      <div class="courtesy-note">Courtesy table</div>
                      <div class="courtesy-note muted">$0 due</div>
                    </ng-template>
                    <div
                      class="deadline"
                      *ngIf="isEditPendingOrPartial(i)"
                    >
                      <input
                        type="time"
                        formControlName="paymentDeadlineTime"
                      />
                      <select
                        formControlName="paymentDeadlineTz"
                      >
                        <option value="America/Chicago">America/Chicago</option>
                        <option value="UTC">UTC</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <label>
                    Status
                    <select formControlName="status">
                      <option value="ACTIVE">ACTIVE</option>
                      <option value="DISABLED">DISABLED</option>
                    </select>
                  </label>
                  <label class="wide">
                    Notes
                    <input type="text" formControlName="notes" />
                  </label>
                </div>
                <div class="actions">
                  <button type="submit" [disabled]="editForm.invalid || loading">Save</button>
                  <button type="button" (click)="cancelEdit()" [disabled]="loading">Cancel</button>
                </div>
              </form>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </section>
</section>
